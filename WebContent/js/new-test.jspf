<script type="text/javascript">
$( document ).ready(function() {
   $(".title-section").text($("nav #new-test span").text()).fadeIn(1000);
   
   $('select#source1').formSelect();
	$('select#source2').formSelect();
	$('button#add').click(toggleProgress);
	$('img.close').click(function() {
		var selectElements = $('select');
		closeModal(selectElements);
	});
	
	$('select').each(function() {
		$(this).on('change', function (e) {
			var optionSelected = $("option:selected", this);
		    var valueSelected = this.value;
		    if (valueSelected == '1') {
		    	openModal(this);
		    }
		})
	});
	
	$("#form-new-source").submit(function (event) {
		console.log('submitting new source');
	    var source = $("#input-source").val();
	    createSource(source);
	    event.preventDefault();
	});
});

function openModal(selectElements) {
	/*$(selectElements).find('option:eq(0)').attr('selected',true);
	$(selectElements).val('0');*/
	$("div.modal").css('display', 'block');	
	//$("div#new-test").addClass('blurry');
}

function closeModal(selectElements){
	$(selectElements).find('option:eq(0)').attr('selected',true);
	$(selectElements).val('0');
	$(selectElements).formSelect();
	$("div.modal").css('display', 'none');
	$("div.modal input#input-source").val('');
	//$("div#new-test").removeClass('blurry');
}

function createSource(sourceName) {
	//	function executeAjax(method, url, data, dataType, successFunction, errorFunction){
	var parameters = $.param({ 'source': sourceName }, true);
	executeAjax('POST', 'CreateSource', parameters, 'HTML', success, error, always);
}
	
function success(data) {
	var lastValue = $('select:first option:last').val();
	console.log('data=' + data);
	$("select").append('<option value="' + (lastValue + 1) + '">' + data + '</option>');
	$("ul#list-sources").append('<li>' + data + '</li>'); 
	var selectElements = $('select');
	closeModal(selectElements);
	showSuccessMessage('Source created');
}

function error(jqXHR, textStatus, errorThrown) {
	console.log('Request failed: ' + jqXHR.status);
	showErrorMessage('Error while processing');
}

function always() {
	setTimeout(hideProgress, 1000);
}

function createSource2(sourceName) {
	console.log("Source =" + sourceName);
	$.ajax({
		type : 'POST',
		url : 'CreateSource', // Your Servlet mapping or JSP
		data: { source: sourceName },
		dataType : 'html', // Returns HTML as plain text; included script tags
		// are evaluated when inserted in the DOM.
		success : function exito(data, textStatus, xhr) {
				console.log('Request completed: ' + xhr.status);
				var lastValue = $('select:first option:last').val();
				console.log('Last value = ' + lastValue);

				$("select").append('<option value="' + (lastValue + 1) + '">' + sourceName + '</option>');
				$("ul#list-sources").append('<li>' + sourceName + '</li>'); 
				var selectElements = $('select');
				closeModal(selectElements);
				setTimeout(hideProgress, 1000);
				showMessage('Source created');
				/*
				$("div.modal").css('display', 'none');	
				$("#new-test").removeClass('blurry');
				*/
				/*
				var values = response.split(";");
				if (values[0] === '')
					$('#accion').html("&nbsp");
				else
					$('#accion').html(values[0]);
				if (values[1] === '')
					$("#progreso").html("&nbsp");
				else
					$("#progreso").html(values[1]);
				setTimeout(pollProgressPercentaje, 250 /*0.25 second*/
						/*);
				*/
		}
	});

	return true;
}
</script>